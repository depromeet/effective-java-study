ê³¼ë„í•œ ë™ê¸°í™”ëŠ” ì˜¤íˆë ¤ ì„±ëŠ¥ì„ ë–¨ì–´íŠ¸ë¦¬ê³ , êµì°©ìƒíƒœì— ë¹ ëœ¨ë¦°ë‹¤.

### â˜ï¸ ê³¼ë„í•œ ë™ê¸°í™” ì˜ˆì‹œ 

**ì¬ì •ì˜ ê°€ëŠ¥í•œ ë©”ì„œë“œë‚˜ í´ë¼ë¦¬ì–¸íŠ¸ê°€ ë„˜ê²¨ì¤€ í•¨ìˆ˜ ê°ì²´**ë¥¼ ë™ê¸°í™” ì˜ì—­ ì•ˆì—ì„œ í˜¸ì¶œí•˜ë©´ ì–´ë–¤ ì§“ì„ í•˜ëŠ”ì§€ í†µì œí•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ì˜ˆì™¸ë¥¼ ì¼ìœ¼í‚¤ê±°ë‚˜ êµì°©ìƒíƒœì— ë¹ ì§€ê±°ë‚˜, ë°ì´í„°ë¥¼ í›¼ì†í•  ìˆ˜ ìˆë‹¤.

```java
    interface SetObserver<E> {
         // ObservableSetì— ì›ì†Œê°€ ë”í•´ì§€ë©´ í˜¸ì¶œëœë‹¤.
         void added(ObservableSet<E> set, E element);
    }
```
ë‹¤ìŒì€ ì•„ì´í…œ 18ì—ì„œ ë³´ì•˜ë˜ ì»´í¬ì§€ì…˜ì„ í™œìš©í•œ ì½”ë“œì´ë‹¤.
```java 
    class ObservableSet<E> extends ForwardingSet<E> { // ë˜í¼ í´ë˜ìŠ¤
        public ObservableSet(Set<E> set) {
            super(set);
        }

        private final List<SetObserver<E>> observers
                = new ArrayList<>();

        public void addObserver(SetObserver<E> observer) {
            synchronized (observers) {
                observers.add(observer);
            }
        }

        public boolean removeObserver(SetObserver<E> observer) {
            synchronized (observers) {
                return observers.remove(observer);
            }
        }

        private void notifyElementAdded(E element) {
            synchronized (observers) {
                for (SetObserver<E> observer : observers)
                    observer.added(this, element);
            }
        }
        
        @Override public boolean add(E element) {
            boolean added = super.add(element);
            if (added)
                notifyElementAdded(element);
            return added;
        }

        @Override public boolean addAll(Collection<? extends E> c) {
            boolean result = false;
            for (E element : c)
                result |= add(element);  // notifyElementAddedë¥¼ í˜¸ì¶œí•œë‹¤.
            return result;
        }
    }
```

í•˜ì§€ë§Œ, ì´ ì½”ë“œëŠ” ì™¸ë¶€ì—ì„œ í•¨ìˆ˜ ê°ì²´( `SetObserver` )ë¥¼ ë°›ì•„ì˜¤ê¸° ë•Œë¬¸ì—  ì•„ë˜ì™€ ê°™ì€ ë‘ê°€ì§€ ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆëŠ” ìœ„í—˜ì— ë…¸ì¶œë˜ì–´ ìˆë‹¤.

#### 1. ConcurrentModificationException ì˜ˆì™¸
í•œ ìŠ¤ë ˆë“œë§Œ `observer` ë¦¬ìŠ¤íŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë™ê¸°í™” ê´€ë ¨ ì˜ˆì™¸ê°€ í„°ì§€ì§€ ì•Šì„ê²ƒ ê°™ì•„ ë³´ì¸ë‹¤.

```java
public class Test2 {
    public static void main(String[] args) {
        ObservableSet<Integer> set = new ObservableSet<>(new HashSet<>());

        set.addObserver(new SetObserver<>() {
            public void added(ObservableSet<Integer> s, Integer e) {
                System.out.println(e);
                if (e == 23) // ê°’ì´ 23ì´ë©´ ìì‹ ì„ êµ¬ë…í•´ì§€
                    s.removeObserver(this);
            }
        });
    }
}
```

í•˜ì§€ë§Œ ì™¸ë¶€ í•¨ìˆ˜ ê°ì²´ ë©”ì„œë“œì¸ `added()` ê°€ ë™ê¸°í™” ë¸”ëŸ­ ë‚´ì— ì¡´ì¬í•˜ê²Œ ë˜ë©´ì„œ, ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œë¥¼ ì•¼ê¸°í•œë‹¤.

1. `addObserver()` -> `add()` -> `notifyElementAdded` -> `added()` í˜¸ì¶œ
2. `added()` -> `removeObserver()` í˜¸ì¶œ

ì´ë¯¸ 1ë²ˆ ê³¼ì •ì—ì„œ ì—ì„œ `observers` ë¥¼ `synchronized` ê°ì‹¸ê³  ìˆìŒì—ë„, ì½œë°±ì„ ê±°ì³ ëŒì•„ì™€ì„œ ìˆ˜ì •ë˜ëŠ” ê²ƒê¹Œì§€ ë§‰ì§€ëŠ” ëª»í•˜ê¸° ë•Œë¬¸ì— ê°™ì€ ë¦¬ìŠ¤íŠ¸ë¥¼ ë™ì‹œì— ìˆ˜ì •í•˜ë ¤ê³  ì ‘ê·¼í•˜ê²Œ ë˜ê³  `ConcurrentModificationException` ì´ ë°œìƒí•˜ê²Œ ëœë‹¤.

#### 2. êµì°© ìƒíƒœ(DeadLock) 

ì´ë²ˆì—ëŠ” 1ë²ˆì—ì„œì˜ ì˜ˆì™¸ë¥¼ í”¼í•˜ê¸° ìœ„í•´ ì•„ì˜ˆ ë‹¤ë¥¸ ìŠ¤ë ˆë“œë¥¼ í†µí•´ ì‘ì—…ì„ ìˆ˜í–‰í•´ë³´ì.

```java
set.addObserver(new SetObserver<>() {
        public void added(ObservableSet<Integer> s, Integer e) {
             System.out.println(e);
             if (e == 23) {
                 ExecutorService exec = Executors.newSingleThreadExecutor();
                 try {
                      exec.submit(() -> s.removeObserver(this)).get();
                 } catch (ExecutionException | InterruptedException ex) {
                        throw new AssertionError(ex);
                 } finally {
                        exec.shutdown();
                }
             }
         }
 });
 ```
í•˜ì§€ë§Œ ì˜ˆì™¸ëŠ” ì¼ì–´ë‚˜ì§€ ì•Šì§€ë§Œ, ë©”ì¸ ìŠ¤ë ˆë“œê°€ `addObserver` ì—ì„œ ì´ë¯¸ `observers` ì— ëŒ€í•œ ë½ì„ ì¥ê³  ìˆê¸° ë•Œë¬¸ì—, ë‹¤ë¥¸ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œê°€ `removeObserver` ë¥¼ í˜¸ì¶œ ì‹œ ë½ì„ ì–»ì„ ìˆ˜ ì—†ì–´ êµì°© ìƒíƒœê°€ ë°œìƒí•œë‹¤. 

![](https://velog.velcdn.com/images/semi-cloud/post/e56bbadf-308a-43b3-975d-a3b64ac761ac/image.png)

#### 3. ë°ì´í„°ì˜ í›¼ì†(ë¶ˆë³€)

ìë°” ê³ ìœ ì˜ ë½ì€ **ì¬ì§„ì…**ì´ ê°€ëŠ¥í•˜ë‹¤. ë”°ë¼ì„œ, ìœ„ì—ì„œì˜ êµì°© ìƒíƒœëŠ” íšŒí”¼í•  ìˆ˜ ìˆë‹¤.

ë¬´ìŠ¨ ë§ì´ëƒ í•˜ë©´, ë½ì˜ íšë“ì´ ë©”ì„œë“œ í˜¸ì¶œ ë‹¨ìœ„ê°€ ì•„ë‹Œ **ìŠ¤ë ˆë“œ ë‹¨ìœ„**ë¡œ ì¼ì–´ë‚œë‹¤ëŠ” ê²ƒì´ë‹¤. ìŠ¤ë ˆë“œ ë‹¨ìœ„ë¡œ ì¼ì–´ë‚˜ê¸° ë•Œë¬¸ì— ê°™ì€ ìŠ¤ë ˆë“œê°€ ë‹¤ë¥¸ `synchronized` ì˜ì—­ì„ ë§Œë‚˜ê²Œ ë˜ë©´ ì—­ì‹œ ëŒ€ê¸°í•˜ì§€ ì•Šê³  ë°”ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.

```java
// ë§Œì•½ ì¬ì§„ì…ì´ ë¶ˆê°€ëŠ¥í–ˆë‹¤ë©´, ë°ë“œë½ì´ ë°œìƒ 
public class Reentrancy {
  public synchronized void a() {
      System.out.println("a");
      b();    // 2. ë™ê¸°í™” êµ¬ê°„ ë°”ë¡œ ì ‘ê·¼ ê°€ëŠ¥
  }

  public synchronized void b() {
      System.out.println("b");
  }

  public static void main(String[] args) {
      new Reentrancy().a(); // 1. ë½ íšë“
  }
}
```

í•˜ì§€ë§Œ ë§Œì•½ ë‹¤ë¥¸ ë™ê¸°í™” ë©”ì„œë“œì—ì„œ ë½ì´ ë³´í˜¸í•˜ê³  ìˆëŠ” ë°ì´í„°ì— ëŒ€í•´ ê´€ë ¨ì´ ì—†ëŠ” ë‹¤ë¥¸ ì‘ì—…ì´ ì§„í–‰ ì¤‘ì´ë¼ë©´, ì´ ì¼ë¡œ ì¸í•´ ë°ì´í„°ê°€ í›¼ì†ë  ìˆ˜ ìˆëŠ” ë¬¸ì œê°€ ë°œìƒí•œë‹¤.


### â˜ï¸ ê³¼ë„í•œ ë™ê¸°í™” ë¬¸ì œ í•´ê²° 

1. ë™ê¸°í™” ë¸”ëŸ­ ì™¸ë¶€ë¡œ ì™¸ê³„ì¸ ë©”ì„œë“œ ë¹¼ê¸°

ë©”ì„œë“œì˜ í˜¸ì¶œì„ ë™ê¸°í™” ë¸”ëŸ­ ë°”ê¹¥ìœ¼ë¡œ ë¹¼ì„œ, ê°€ëŠ¥í•œ í•œ ë™ê¸°í™” ì˜ì—­ì—ì„œ ìˆ˜í–‰í•˜ëŠ” ì¼ì„ ìµœì†Œí™” ì‹œí‚´ìœ¼ë¡œì¨ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤. ë”ë¶ˆì–´ ë¦¬ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•´ì„œ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— êµ³ì´ ë½ ì—†ì´ë„ ì•ˆì „í•˜ê²Œ ìˆœíšŒê°€ ê°€ëŠ¥í•˜ë‹¤.

```java
 private void notifyElementAdded(E element) {
     List<SetObserver<E>> snapshot = null;
     synchronized(observers) {
    	snapshot = new ArrayList<>(observers);
     }
     for (SetObserver<E> observer : snapshot) // ì™¸ë¶€ë¡œ ë¹¼ë‚´ê¸°
        observer.added(this, element);
 }
```

2. CopyOnWirteArrayList ì‚¬ìš©

ë‚´ë¶€ë¥¼ ë³€ê²½í•˜ëŠ” ì‘ì—…ì€ í•­ìƒ ë³µì‚¬ë³¸ì„ í†µí•´ ì´ë£¨ì–´ì§€ê¸° ë•Œë¬¸ì—, ë°ì´í„° ìˆœíšŒ ì‹œ ë™ê¸°í™”ê°€ í•„ìš” ì—†ì–´ ì†ë„ê°€ ë§¤ìš° ë¹ ë¥´ë‹¤ëŠ” ì¥ì ì´ ìˆë‹¤. ë”°ë¼ì„œ ìˆ˜ì •í•  ì¼ì´ ë“œë¬¼ê³  ìˆœíšŒë§Œ ìì£¼ ì¼ì–´ë‚˜ëŠ” ê²½ìš° ì‚¬ìš©í•˜ë©´ ì¢‹ë‹¤.

```java
private final List<SetObserver<E>> observers = new CopyOnWriteArrayList<>();
...
private void notifyElementAdded(E element) {
     for (SetObserver<E> observer : observers)
          observer.added(this, element);
}
```
### â˜ï¸ ë™ê¸°í™” ì‹œ ì£¼ì˜ì 

ê³¼ë„í•˜ê²Œ ë™ê¸°í™”ë¥¼ í•˜ë©´, ë³‘ë ¬ë¡œ ì‹¤í–‰í•˜ëŠ” ì¥ì ì„ ì–»ì§€ ëª»í•˜ê³  ê²½ìŸê³¼ ë©”ëª¨ë¦¬ë¥¼ ì¼ê´€ë˜ê²Œ ë³´ê¸° ìœ„í•œ ì§€ì—° ì‹œê°„ìœ¼ë¡œ ì¸í•´ ì˜¤íˆë ¤ ë¹„íš¨ìœ¨ì ì´ë‹¤.

ë”°ë¼ì„œ ë¶ˆë³€ì´ ì•„ë‹Œ ê°€ë³€ í´ë˜ìŠ¤ë¥¼ ì„¤ê³„í•  ë•ŒëŠ”, ì•„ë˜ì™€ ê°™ì´ ë‘ ê°€ì§€ë¥¼ ê³ ë¯¼í•´ë³´ì.

1. ì™¸ë¶€ì—ì„œ ë™ê¸°í™”
í•´ë‹¹ í´ë˜ìŠ¤ë¥¼ ë™ì‹œì— ì‚¬ìš©í•´ì•¼ í•˜ëŠ” í´ë˜ìŠ¤ê°€ ì™¸ë¶€ì—ì„œ ê°ì²´ ì „ì²´ì— ë™ê¸°í™”ë¥¼ ê±°ëŠ” ë°©ì‹ì´ë‹¤. `ex) java.util`

2. ë‚´ë¶€ì—ì„œ ë™ê¸°í™”
ì™¸ë¶€ë³´ë‹¤ ë™ì‹œì„±ì„ ì›”ë“±íˆ ê°œì„  ê°€ëŠ¥í•  ë•Œë§Œ ì‚¬ìš©í•´ì•¼ í•œë‹¤. 
`ex) java.util.concurrent` ì˜ `ConcurrentHashMap`, `BlockingQueue` ..

> ğŸ”– í•µì‹¬ ì •ë¦¬<br>
êµì°©ìƒíƒœì™€ ë°ì´í„° í›¼ì†ì„ í”¼í•˜ë ¤ë©´ ë™ê¸°í™” ì˜ì—­ ì•ˆì—ì„œ ì™¸ê³„ì¸ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì§€ ë§ê³  ì‘ì—…ì„ ìµœì†Œí•œìœ¼ë¡œ ì¤„ì—¬ì•¼ í•œë‹¤. ë©€í‹°ì½”ì–´ ì„¸ìƒì—ì„œëŠ” ê³¼ë„í•œ ë™ê¸°í™”ë¥¼ í”¼í•˜ëŠ”ê²Œ ì¢‹ê¸° ë•Œë¬¸ì— í•©ë‹¹í•œ ì´ìœ ê°€ ìˆì„ ë•Œë§Œ ë‚´ë¶€ì—ì„œ ë™ê¸°í™”ë¥¼ ì‹œí‚¤ê³ , ë¬¸ì„œì— ì •í™•íˆ ì—¬ë¶€ë¥¼ ë°íˆë„ë¡ í•˜ì.


